---
import Layout from "../layouts/Layout.astro";
---

<Layout
    title="Coast FIRE 計算機 | 提早半退休，讓複利為您工作"
    description="計算您達成 Coast FIRE 的年齡與所需金額。視覺化您的財富自由之路，了解如何透過早期累積讓資產自然增長至退休目標。"
>
    <!-- Structured Data for SEO / AEO -->
    <script type="application/ld+json" is:inline slot="head">
        {
            "@context": "https://schema.org",
            "@graph": [
                {
                    "@type": "SoftwareApplication",
                    "name": "Coast FIRE 計算機",
                    "applicationCategory": "FinanceApplication",
                    "operatingSystem": "Web",
                    "description": "計算您達成 Coast FIRE 的年齡與所需金額，視覺化複利增長與退休目標的關係。",
                    "offers": {
                        "@type": "Offer",
                        "price": "0",
                        "priceCurrency": "TWD"
                    }
                },
                {
                    "@type": "BreadcrumbList",
                    "itemListElement": [
                        {
                            "@type": "ListItem",
                            "position": 1,
                            "name": "首頁",
                            "item": "https://workfree.vercel.app/"
                        },
                        {
                            "@type": "ListItem",
                            "position": 2,
                            "name": "Coast FIRE 計算",
                            "item": "https://workfree.vercel.app/coast-fire"
                        }
                    ]
                }
            ]
        }
    </script>
    <main
        class="container mx-auto px-4 py-8 md:py-12 max-w-6xl min-h-screen relative z-10"
    >
        <!-- Header -->
        <div class="text-center mb-12 animate-fade-in-down">
            <h1
                class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight"
            >
                Coast FIRE 計算機
            </h1>
            <p class="text-lg text-slate-500 font-medium">
                讓複利為您工作，預見各種財務可能。
            </p>
        </div>

        <!-- Concept Card -->
        <div
            class="bg-blue-50/50 border border-blue-100 rounded-2xl p-6 mb-12 max-w-3xl mx-auto text-center"
        >
            <h3 class="text-blue-700 font-bold mb-2">什麼是 Coast FIRE?</h3>
            <p class="text-slate-600 text-sm leading-relaxed">
                Coast FIRE state 是指您已經存夠了退休金的本金。從現在開始，您<strong
                    class="text-blue-600">不需要再為退休存一毛錢</strong
                >，只需讓資產透過複利自然增長，就能在退休時達到目標金額。這意味著您可以選擇輕鬆一點的工作
                (Coast)，只需賺取足夠覆蓋當下生活費的薪水即可。
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Controls Panel -->
            <div
                class="lg:col-span-4 space-y-6 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm h-fit sticky top-24"
            >
                <h2
                    class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2"
                >
                    <span class="w-1 h-6 bg-blue-600 rounded-full"></span>
                    參數設定
                </h2>

                <!-- Mainstream Toggle -->
                <div
                    class="p-4 rounded-2xl bg-blue-50 border border-blue-100 mb-6 group cursor-pointer hover:bg-blue-100 transition-all duration-300"
                    id="mainstream-toggle-container"
                >
                    <label class="flex items-center gap-3 cursor-pointer">
                        <div class="relative inline-flex items-center">
                            <input
                                type="checkbox"
                                id="mainstream-toggle"
                                class="sr-only peer"
                            />
                            <div
                                class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
                            >
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-blue-900"
                                >載入台灣上班族主流試算</span
                            >
                            <span class="text-[10px] text-blue-700/70"
                                >30歲、100萬本金、5萬月支出</span
                            >
                        </div>
                    </label>
                </div>

                <!-- Age Group -->
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label
                            class="flex justify-between text-sm font-semibold text-slate-600"
                        >
                            現在年齡 <span id="val-age" class="text-blue-600"
                                >30</span
                            >
                        </label>
                        <input
                            type="range"
                            id="age"
                            min="20"
                            max="60"
                            value="30"
                            class="w-full accent-blue-600 cursor-pointer"
                        />
                    </div>
                    <div class="space-y-2">
                        <label
                            class="flex justify-between text-sm font-semibold text-slate-600"
                        >
                            預計退休年齡 <span
                                id="val-retire-age"
                                class="text-blue-600">60</span
                            >
                        </label>
                        <input
                            type="range"
                            id="retire-age"
                            min="30"
                            max="80"
                            value="60"
                            class="w-full accent-blue-600 cursor-pointer"
                        />
                    </div>
                </div>

                <div class="h-px bg-slate-100"></div>

                <!-- Money Group -->
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label
                            class="flex justify-between text-sm font-semibold text-slate-600"
                        >
                            目前已投資資產 (TWD) <span
                                id="val-current-assets"
                                class="text-blue-600 font-mono text-xs"
                                >$1,000,000</span
                            >
                        </label>
                        <input
                            type="range"
                            id="current-assets"
                            min="0"
                            max="20000000"
                            step="100000"
                            value="1000000"
                            class="w-full accent-blue-600 cursor-pointer"
                        />
                    </div>
                    <div class="space-y-2">
                        <label
                            class="flex justify-between text-sm font-semibold text-slate-600"
                        >
                            年投資報酬率 (%) <span
                                id="val-return-rate"
                                class="text-blue-600">7%</span
                            >
                        </label>
                        <input
                            type="range"
                            id="return-rate"
                            min="1"
                            max="15"
                            step="0.5"
                            value="7"
                            class="w-full accent-blue-600 cursor-pointer"
                        />
                    </div>
                    <div class="space-y-2">
                        <label
                            class="flex justify-between text-sm font-semibold text-slate-600"
                        >
                            預估通膨率 (%) <span
                                id="val-inflation"
                                class="text-blue-600">2%</span
                            >
                        </label>
                        <input
                            type="range"
                            id="inflation"
                            min="0"
                            max="10"
                            step="0.5"
                            value="2"
                            class="w-full accent-blue-600 cursor-pointer"
                        />
                    </div>
                </div>

                <div class="h-px bg-slate-100"></div>

                <div class="space-y-4">
                    <div class="space-y-2">
                        <label
                            class="flex justify-between text-sm font-semibold text-slate-600"
                        >
                            退休後年支出 (現值) <span
                                id="val-annual-spend"
                                class="text-blue-600 font-mono text-xs"
                                >$600,000</span
                            >
                        </label>
                        <div class="text-xs text-slate-400 mb-1">
                            依據 4% 法則計算需求
                        </div>
                        <input
                            type="range"
                            id="annual-spend"
                            min="300000"
                            max="3000000"
                            step="10000"
                            value="600000"
                            class="w-full accent-blue-600 cursor-pointer"
                        />
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Verdict Card -->
                <div
                    class="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden shadow-xl"
                    id="verdict-card"
                >
                    <div
                        class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full blur-[80px] opacity-20 -mr-16 -mt-16"
                    >
                    </div>
                    <div class="relative z-10">
                        <div
                            class="uppercase tracking-widest text-blue-400 text-xs font-bold mb-2"
                        >
                            Coast FIRE Status
                        </div>
                        <h2
                            class="text-3xl md:text-4xl font-bold mb-4"
                            id="verdict-title"
                        >
                            計算中...
                        </h2>
                        <p
                            class="text-slate-300 text-lg leading-relaxed mb-6"
                            id="verdict-desc"
                        >
                            調整左側參數來查看您的複利成長曲線。
                        </p>

                        <div
                            class="grid grid-cols-2 gap-4 mt-8 p-4 bg-white/5 rounded-2xl border border-white/10"
                        >
                            <div>
                                <div
                                    class="text-slate-400 text-xs uppercase tracking-wider mb-1"
                                >
                                    退休所需金額 (通膨調整後)
                                </div>
                                <div
                                    class="text-2xl font-mono font-bold text-blue-400"
                                    id="target-number"
                                >
                                    $0
                                </div>
                            </div>
                            <div>
                                <div
                                    class="text-slate-400 text-xs uppercase tracking-wider mb-1"
                                >
                                    Coast FIRE 達成年齡
                                </div>
                                <div
                                    class="text-2xl font-mono font-bold text-emerald-400"
                                    id="coast-age"
                                >
                                    --
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Card -->
                <div
                    class="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm h-[400px] relative"
                >
                    <canvas id="fireChart"></canvas>
                </div>

                <!-- Chart Legend/Explainer -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div
                        class="p-4 rounded-xl bg-blue-50 border border-blue-100 flex gap-3 items-center"
                    >
                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                        <div class="text-sm text-slate-700">
                            <strong>資產成長曲線</strong
                            >：即使不再存錢，您的資產也會隨複利增長。
                        </div>
                    </div>
                    <div
                        class="p-4 rounded-xl bg-rose-50 border border-rose-100 flex gap-3 items-center"
                    >
                        <div
                            class="w-3 h-3 rounded-full bg-rose-500 border-2 border-dashed border-rose-300"
                        >
                        </div>
                        <div class="text-sm text-slate-700">
                            <strong>退休目標</strong
                            >：考慮通膨後，您在退休那一年需要的總資產
                            (25倍年支出)。
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Educational Content Section for AEO -->
        <section
            class="mt-24 max-w-4xl mx-auto space-y-16 border-t border-slate-100 pt-16 pb-24"
        >
            <div class="space-y-8">
                <h2
                    class="text-3xl font-extrabold text-slate-900 tracking-tight text-center"
                >
                    深入了解 Coast FIRE
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3
                            class="text-xl font-bold text-slate-900 flex items-center gap-2"
                        >
                            <span class="w-1.5 h-6 bg-blue-600 rounded-full"
                            ></span>
                            Coast FIRE 與傳統 FIRE 有什麼不同？
                        </h3>
                        <p class="text-slate-600 leading-relaxed text-sm">
                            傳統 FIRE (Financial Independence, Retire Early)
                            要求積累到足以支付「餘生所有開銷」的資產後才停止工作。而
                            Coast FIRE
                            則是先快速積累一筆「退休種子」，之後只需靠複利自然增長至退休年齡，您可以選擇大幅減輕工作壓力，只需賺取足以「覆蓋現下生活費」的薪水。
                        </p>
                    </div>
                    <div class="space-y-4">
                        <h3
                            class="text-xl font-bold text-slate-900 flex items-center gap-2"
                        >
                            <span class="w-1.5 h-6 bg-blue-600 rounded-full"
                            ></span>
                            為什麼愈早開始愈好？
                        </h3>
                        <p class="text-slate-600 leading-relaxed text-sm">
                            Coast FIRE
                            的核心動力是「複利」與「時間」。同樣的退休目標，25
                            歲開始投入 100 萬，與 35
                            歲才開始，在複利效應下，最終的結果會有數倍的差距。愈早達成
                            Coast FIRE 點，您就愈早獲得對職業生涯的「選擇權」。
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 rounded-[2.5rem] p-8 md:p-12">
                <h3
                    class="text-2xl font-extrabold text-blue-900 mb-8 text-center"
                >
                    常見問題 FAQ
                </h3>
                <div class="space-y-6">
                    <div
                        class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 border border-blue-100 shadow-sm"
                    >
                        <h4 class="text-lg font-bold text-slate-900 mb-2">
                            如何計算我的 Coast FIRE 數字？
                        </h4>
                        <p class="text-slate-600 text-sm">
                            演算法會根據您的預計退休年齡、期望的退休支出以及預估的投資報酬率，反向推算出您「現在」必須擁有多少資產，才能在不做額外投入的情況下，靠複利在那一天準時達標。
                        </p>
                    </div>
                    <div
                        class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 border border-blue-100 shadow-sm"
                    >
                        <h4 class="text-lg font-bold text-slate-900 mb-2">
                            達成 Coast FIRE 後我該辭職嗎？
                        </h4>
                        <p class="text-slate-600 text-sm">
                            這取決於您。Coast FIRE
                            提供的是「心理安全感」。達成後，您不再需要為了存退休金而忍受高壓工作，可以切換到半職、兼職或自己感興趣但收入較低的事業，只要能支付當前的日常開銷即可。
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        import Chart from "chart.js/auto";

        // State
        const state = {
            age: 30,
            retireAge: 60,
            currentAssets: 1000000,
            returnRate: 7,
            inflation: 2,
            annualSpend: 600000,
        };

        let chart: any = null;

        // Elements
        const inputs = {
            age: document.getElementById("age") as HTMLInputElement,
            retireAge: document.getElementById(
                "retire-age",
            ) as HTMLInputElement,
            currentAssets: document.getElementById(
                "current-assets",
            ) as HTMLInputElement,
            returnRate: document.getElementById(
                "return-rate",
            ) as HTMLInputElement,
            inflation: document.getElementById("inflation") as HTMLInputElement,
            annualSpend: document.getElementById(
                "annual-spend",
            ) as HTMLInputElement,
        };

        const labels = {
            age: document.getElementById("val-age"),
            retireAge: document.getElementById("val-retire-age"),
            currentAssets: document.getElementById("val-current-assets"),
            returnRate: document.getElementById("val-return-rate"),
            inflation: document.getElementById("val-inflation"),
            annualSpend: document.getElementById("val-annual-spend"),
            verdictTitle: document.getElementById("verdict-title"),
            verdictDesc: document.getElementById("verdict-desc"),
            targetNumber: document.getElementById("target-number"),
            coastAge: document.getElementById("coast-age"),
            mainstreamToggle: document.getElementById(
                "mainstream-toggle",
            ) as HTMLInputElement,
        };

        // Formatter
        const moneyFmt = new Intl.NumberFormat("zh-TW", {
            style: "currency",
            currency: "TWD",
            maximumFractionDigits: 0,
        });

        function init() {
            // Bind events
            Object.keys(inputs).forEach((key) => {
                const el = inputs[key as keyof typeof inputs];
                if (el) {
                    el.addEventListener("input", (e) => {
                        const target = e.target as HTMLInputElement;
                        (state as any)[key] = parseFloat(target.value);
                        update();
                    });
                }
            });

            // Mainstream Toggle Logic
            if (labels.mainstreamToggle) {
                labels.mainstreamToggle.addEventListener("change", (e) => {
                    const checked = (e.target as HTMLInputElement).checked;
                    if (checked) {
                        state.age = 30;
                        state.retireAge = 60;
                        state.currentAssets = 1000000;
                        state.returnRate = 7;
                        state.inflation = 2;
                        state.annualSpend = 600000;

                        // Sync UI
                        inputs.age.value = "30";
                        inputs.retireAge.value = "60";
                        inputs.currentAssets.value = "1000000";
                        inputs.returnRate.value = "7";
                        inputs.inflation.value = "2";
                        inputs.annualSpend.value = "600000";
                    }
                    update();
                });
            }

            update();
        }

        function calculate() {
            const yearsToRetire = state.retireAge - state.age;
            const realRate = (state.returnRate - state.inflation) / 100; // Simplified real return

            // 1. Calculate Target FIRE Number at Retirement Age
            // Rule of 25: Annual Spend / 0.04
            // Inflation adjust the spending needs
            const futureAnnualSpend =
                state.annualSpend *
                Math.pow(1 + state.inflation / 100, yearsToRetire);
            const targetFireNumber = futureAnnualSpend * 25;

            // 2. Generate Data Points
            const labels = [];
            const assetData = [];
            const targetData = [];
            let coastAge = -1;

            // Projection from Age to 85
            const endAge = 85;

            for (let i = state.age; i <= endAge; i++) {
                labels.push(i);

                // Year index
                const yearIdx = i - state.age;

                // Asset Growth (Compound Interest)
                // FV = PV * (1 + r)^n
                // Note: Use nominal rate for raw number growth, but target also inflates?
                // Better to work in "Future Value" nominal terms for chart lines.
                const nominalReturn = state.returnRate / 100;
                const currentAssetValue =
                    state.currentAssets * Math.pow(1 + nominalReturn, yearIdx);
                assetData.push(currentAssetValue);

                // Target Line
                // This is tricky. Do we show the target as a flat line in REAL terms or curved in NOMINAL terms?
                // Let's use Nominal curve for Target too.
                // Target at year X = (Base Annual Spend * (1+inflation)^yearX) * 25
                const yearInflation = Math.pow(
                    1 + state.inflation / 100,
                    yearIdx,
                );
                const nominalTarget = state.annualSpend * yearInflation * 25;

                // For visual simplicity, let's just show the Final Target at Retirement Age extended flat?
                // Or better: The amount you NEED to have at any given age to be "Coast FIREd"?
                // Coast FIRE Number at Age X = Target_at_Retirement / (1 + r)^(RetireAge - Age)
                // No, user wants to see "Growth Curve vs Target".
                // Let's stick to: Line 1 = Asset Growth. Line 2 = Nominal Target Needed.
                // Actually simplest Coast FIRE viz is:
                // Do your assets grow to hit the Target Fire Number at Retire Age?

                targetData.push(nominalTarget); // This shows the moving goalpost due to inflation

                // Check if crossed
                if (currentAssetValue >= nominalTarget && coastAge === -1) {
                    coastAge = i;
                }
            }

            return {
                assetData,
                targetData,
                labels,
                targetFireNumber,
                coastAge,
            };
        }

        function update() {
            // Update labels
            if (labels.age) labels.age.textContent = state.age.toString();
            if (labels.retireAge)
                labels.retireAge.textContent = state.retireAge.toString();
            if (labels.currentAssets)
                labels.currentAssets.textContent = moneyFmt.format(
                    state.currentAssets,
                );
            if (labels.returnRate)
                labels.returnRate.textContent = state.returnRate + "%";
            if (labels.inflation)
                labels.inflation.textContent = state.inflation + "%";
            if (labels.annualSpend)
                labels.annualSpend.textContent = moneyFmt.format(
                    state.annualSpend,
                );

            const res = calculate();

            // Update Verdict
            if (labels.targetNumber)
                labels.targetNumber.textContent = moneyFmt.format(
                    res.targetFireNumber,
                );

            // Final Status Check
            const projectedAtRetire =
                res.assetData[state.retireAge - state.age];

            if (projectedAtRetire >= res.targetFireNumber) {
                if (labels.verdictTitle) {
                    labels.verdictTitle.textContent = "已達成 Coast FIRE！";
                    labels.verdictTitle.className =
                        "text-3xl md:text-4xl font-bold mb-4 text-emerald-400";
                }
                if (labels.verdictDesc)
                    labels.verdictDesc.textContent = `恭喜！以目前 ${moneyFmt.format(state.currentAssets)} 的資產，即便不再投入任何新資金，靠著 ${state.returnRate}% 的複利滾動，在 ${state.retireAge} 歲退休時將成長至 ${moneyFmt.format(projectedAtRetire)}，超過您需要的 ${moneyFmt.format(res.targetFireNumber)}。`;
                if (labels.coastAge)
                    labels.coastAge.textContent =
                        res.coastAge > state.age
                            ? `${res.coastAge} 歲`
                            : "現在";
            } else {
                if (labels.verdictTitle) {
                    labels.verdictTitle.textContent = "尚未達成";
                    labels.verdictTitle.className =
                        "text-3xl md:text-4xl font-bold mb-4 text-rose-400";
                }
                if (labels.verdictDesc)
                    labels.verdictDesc.textContent = `還差一點！您在 ${state.retireAge} 歲預期會擁有 ${moneyFmt.format(projectedAtRetire)}，但您的目標是 ${moneyFmt.format(res.targetFireNumber)}。建議增加本金或延後退休。`;
                if (labels.coastAge) labels.coastAge.textContent = "加油";
            }

            renderChart(res);
        }

        function renderChart(data: any) {
            const ctx = document.getElementById(
                "fireChart",
            ) as HTMLCanvasElement;
            if (!ctx) return;

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: "資產複利成長",
                            data: data.assetData,
                            borderColor: "#3b82f6", // blue-500
                            backgroundColor: "rgba(59, 130, 246, 0.1)",
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                        },
                        {
                            label: "FIRE 目標門檻 (含通膨)",
                            data: data.targetData,
                            borderColor: "#f43f5e", // rose-500
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.4,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        mode: "index",
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: "white",
                            titleColor: "#1e293b",
                            bodyColor: "#475569",
                            borderColor: "#e2e8f0",
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || "";
                                    if (label) {
                                        label += ": ";
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat(
                                            "zh-TW",
                                            {
                                                style: "currency",
                                                currency: "TWD",
                                                maximumFractionDigits: 0,
                                            },
                                        ).format(context.parsed.y);
                                    }
                                    return label;
                                },
                            },
                        },
                        legend: {
                            display: false,
                        },
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false,
                            },
                            title: {
                                display: true,
                                text: "年齡",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value, index, values) {
                                    // @ts-ignore
                                    return "$" + value / 10000 + "萬";
                                },
                            },
                            border: {
                                display: false,
                            },
                        },
                    },
                },
            });
        }

        // Start
        init();
    </script>
</Layout>
