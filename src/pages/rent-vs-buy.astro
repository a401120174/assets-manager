---
import Layout from "../layouts/Layout.astro";
---

<Layout
    title="買房 vs 租房計算器 | 視覺化您的居住決策與機會成本"
    description="利用數據分析買房與租房的長期淨資產差異。考慮房價漲幅、租金通膨與投資機會成本，找到您的居住黃金交叉點。"
>
    <!-- Structured Data for SEO / AEO -->
    <script type="application/ld+json" is:inline slot="head">
        {
            "@context": "https://schema.org",
            "@graph": [
                {
                    "@type": "SoftwareApplication",
                    "name": "買房 vs 租房計算機",
                    "applicationCategory": "FinanceApplication",
                    "operatingSystem": "Web",
                    "description": "考慮機會成本，計算買房與租房的長期淨資產差異，協助使用者做出理性的居住決策。",
                    "offers": {
                        "@type": "Offer",
                        "price": "0",
                        "priceCurrency": "TWD"
                    }
                },
                {
                    "@type": "BreadcrumbList",
                    "itemListElement": [
                        {
                            "@type": "ListItem",
                            "position": 1,
                            "name": "首頁",
                            "item": "https://assets-manager-beige.vercel.app/"
                        },
                        {
                            "@type": "ListItem",
                            "position": 2,
                            "name": "買房 vs 租房",
                            "item": "https://assets-manager-beige.vercel.app/rent-vs-buy"
                        }
                    ]
                }
            ]
        }
    </script>
    <main
        class="container mx-auto px-4 py-8 md:py-12 max-w-7xl min-h-screen relative z-10"
    >
        <!-- Header -->
        <div class="text-center mb-12 animate-fade-in-down">
            <h1
                class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight"
            >
                買房 vs 租房
            </h1>
            <p class="text-lg text-slate-500 font-medium">
                不只是房貸與租金的比較，更是「機會成本」的對決。
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Parameters Panel -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Buying Section -->
                <div
                    class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm"
                >
                    <h2
                        class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2"
                    >
                        <span class="w-1 h-5 bg-blue-600 rounded-full"></span>
                        買房參數 (Buying)
                    </h2>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label
                                class="flex justify-between text-sm font-semibold text-slate-600"
                            >
                                房屋總價 <span
                                    id="val-home-price"
                                    class="text-blue-600 font-mono"
                                    >$20,000,000</span
                                >
                            </label>
                            <input
                                type="range"
                                id="home-price"
                                min="5000000"
                                max="100000000"
                                step="100000"
                                value="20000000"
                                class="w-full accent-blue-600 cursor-pointer"
                            />
                        </div>
                        <div class="space-y-1">
                            <label
                                class="flex justify-between text-sm font-semibold text-slate-600"
                            >
                                頭期款比例 (%) <span
                                    id="val-down-payment"
                                    class="text-blue-600">20%</span
                                >
                            </label>
                            <input
                                type="range"
                                id="down-payment"
                                min="10"
                                max="100"
                                step="5"
                                value="20"
                                class="w-full accent-blue-600 cursor-pointer"
                            />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label
                                    class="flex justify-between text-xs font-semibold text-slate-500"
                                >
                                    房貸利率 (%) <span
                                        id="val-mortgage-rate"
                                        class="text-blue-600">2.2%</span
                                    >
                                </label>
                                <input
                                    type="range"
                                    id="mortgage-rate"
                                    min="1"
                                    max="5"
                                    step="0.1"
                                    value="2.2"
                                    class="w-full accent-blue-600 cursor-pointer"
                                />
                            </div>
                            <div class="space-y-1">
                                <label
                                    class="flex justify-between text-xs font-semibold text-slate-500"
                                >
                                    貸款年限 <span
                                        id="val-mortgage-years"
                                        class="text-blue-600">30年</span
                                    >
                                </label>
                                <input
                                    type="range"
                                    id="mortgage-years"
                                    min="10"
                                    max="40"
                                    step="5"
                                    value="30"
                                    class="w-full accent-blue-600 cursor-pointer"
                                />
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label
                                class="flex justify-between text-sm font-semibold text-slate-600"
                            >
                                預期房價年漲幅 (%) <span
                                    id="val-appreciation"
                                    class="text-blue-600">2%</span
                                >
                            </label>
                            <input
                                type="range"
                                id="appreciation"
                                min="0"
                                max="10"
                                step="0.5"
                                value="2"
                                class="w-full accent-blue-600 cursor-pointer"
                            />
                        </div>
                        <div class="space-y-1 pt-2 border-t border-slate-100">
                            <label
                                class="flex justify-between text-xs font-semibold text-slate-500"
                                title="包含稅金、維護費、保險等"
                            >
                                持有成本 (年/總價%) <span
                                    id="val-holding-cost"
                                    class="text-slate-600">1.5%</span
                                >
                            </label>
                            <input
                                type="range"
                                id="holding-cost"
                                min="0.5"
                                max="3"
                                step="0.1"
                                value="1.5"
                                class="w-full accent-slate-400 cursor-pointer"
                            />
                        </div>
                        <div class="space-y-1">
                            <label
                                class="flex justify-between text-xs font-semibold text-slate-500"
                            >
                                每月管理費 <span
                                    id="val-mgmt-fee"
                                    class="text-slate-600">$3,000</span
                                >
                            </label>
                            <input
                                type="range"
                                id="mgmt-fee"
                                min="0"
                                max="15000"
                                step="100"
                                value="3000"
                                class="w-full accent-slate-400 cursor-pointer"
                            />
                        </div>
                    </div>
                </div>

                <!-- Renting Section -->
                <div
                    class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm"
                >
                    <h2
                        class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2"
                    >
                        <span class="w-1 h-5 bg-emerald-500 rounded-full"
                        ></span>
                        租房參數 (Renting)
                    </h2>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label
                                class="flex justify-between text-sm font-semibold text-slate-600"
                            >
                                每月租金 <span
                                    id="val-rent"
                                    class="text-emerald-600 font-mono"
                                    >$35,000</span
                                >
                            </label>
                            <input
                                type="range"
                                id="rent"
                                min="5000"
                                max="200000"
                                step="1000"
                                value="35000"
                                class="w-full accent-emerald-500 cursor-pointer"
                            />
                        </div>
                        <div class="space-y-1">
                            <label
                                class="flex justify-between text-sm font-semibold text-slate-600"
                            >
                                租金年漲幅 (%) <span
                                    id="val-rent-inflation"
                                    class="text-emerald-600">2%</span
                                >
                            </label>
                            <input
                                type="range"
                                id="rent-inflation"
                                min="0"
                                max="8"
                                step="0.5"
                                value="2"
                                class="w-full accent-emerald-500 cursor-pointer"
                            />
                        </div>
                    </div>
                </div>

                <!-- Opportunity Cost Section -->
                <div
                    class="bg-amber-50 p-6 rounded-3xl border border-amber-100 shadow-sm relative overflow-hidden"
                >
                    <div
                        class="absolute -right-4 -top-4 w-24 h-24 bg-amber-200 rounded-full opacity-20 blur-xl"
                    >
                    </div>
                    <h2
                        class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2 relative z-10"
                    >
                        <span class="w-1 h-5 bg-amber-500 rounded-full"></span>
                        機會成本 (Opportunity)
                    </h2>
                    <div class="space-y-1 relative z-10">
                        <label
                            class="flex justify-between text-sm font-semibold text-slate-600"
                        >
                            投資年化報酬率 (%) <span
                                id="val-invest-return"
                                class="text-amber-600">7%</span
                            >
                        </label>
                        <p class="text-[10px] text-slate-500 mb-2">
                            如果您不買房，將頭期款及每月省下的差額拿去投資...
                        </p>
                        <input
                            type="range"
                            id="invest-return"
                            min="1"
                            max="15"
                            step="0.5"
                            value="7"
                            class="w-full accent-amber-500 cursor-pointer"
                        />
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Verdict Card -->
                <div
                    class="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden shadow-xl"
                >
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10"
                    >
                        <div>
                            <div
                                class="uppercase tracking-widest text-slate-400 text-xs font-bold mb-2"
                            >
                                租買對決 (30年後淨資產)
                            </div>
                            <div class="flex items-end gap-2 mb-1">
                                <span class="text-sm text-blue-400 font-bold"
                                    >買房</span
                                >
                                <span
                                    class="text-2xl font-mono font-bold"
                                    id="res-buy-nw">$0</span
                                >
                            </div>
                            <div class="flex items-end gap-2">
                                <span class="text-sm text-emerald-400 font-bold"
                                    >租房</span
                                >
                                <span
                                    class="text-2xl font-mono font-bold"
                                    id="res-rent-nw">$0</span
                                >
                            </div>
                        </div>
                        <div
                            class="flex flex-col justify-center border-t md:border-t-0 md:border-l border-white/10 md:pl-8 pt-4 md:pt-0"
                        >
                            <div
                                class="uppercase tracking-widest text-slate-400 text-xs font-bold mb-2"
                            >
                                黃金交叉點
                            </div>
                            <h3
                                class="text-3xl font-bold text-amber-400 mb-2"
                                id="breakeven-text"
                            >
                                計算中...
                            </h3>
                            <p
                                class="text-slate-400 text-sm leading-relaxed"
                                id="verdict-desc"
                            >
                                --
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Chart Card -->
                <div
                    class="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm h-[500px] relative"
                >
                    <canvas id="comparisonChart"></canvas>
                </div>

                <!-- Analysis Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div
                        class="p-5 rounded-2xl bg-white border border-slate-200 shadow-sm"
                    >
                        <div class="flex items-center gap-2 mb-3">
                            <div
                                class="p-2 bg-blue-50 rounded-lg text-blue-600"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path d="M3 21h18"></path><path
                                        d="M5 21V7l8-4 8 4v14"></path><path
                                        d="M9 10a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v11"
                                    ></path></svg
                                >
                            </div>
                            <h4 class="font-bold text-slate-900">買房優勢</h4>
                        </div>
                        <ul
                            class="text-sm text-slate-600 space-y-2 list-disc pl-4"
                        >
                            <li>強迫儲蓄：房貸本金即是存錢</li>
                            <li>槓桿效應：用少數頭期款享受全額資產增值</li>
                            <li>居住安定感與抗通膨</li>
                        </ul>
                    </div>
                    <div
                        class="p-5 rounded-2xl bg-white border border-slate-200 shadow-sm"
                    >
                        <div class="flex items-center gap-2 mb-3">
                            <div
                                class="p-2 bg-emerald-50 rounded-lg text-emerald-600"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><line x1="12" y1="1" x2="12" y2="23"
                                    ></line><path
                                        d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                                    ></path></svg
                                >
                            </div>
                            <h4 class="font-bold text-slate-900">租房優勢</h4>
                        </div>
                        <ul
                            class="text-sm text-slate-600 space-y-2 list-disc pl-4"
                        >
                            <li>現金流彈性：初期負擔通常較低</li>
                            <li>機會成本：資金投入股市報酬率可能高於房市</li>
                            <li>移動自由度：不受房產地點綁定</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Educational Content Section for AEO -->
        <section
            class="mt-24 max-w-4xl mx-auto space-y-16 border-t border-slate-100 pt-16 pb-24"
        >
            <div class="space-y-8">
                <h2
                    class="text-3xl font-extrabold text-slate-900 tracking-tight text-center"
                >
                    買房還是租房？讓數據說話
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3
                            class="text-xl font-bold text-slate-900 flex items-center gap-2"
                        >
                            <span class="w-1.5 h-6 bg-blue-600 rounded-full"
                            ></span>
                            什麼是「機會成本」？
                        </h3>
                        <p class="text-slate-600 leading-relaxed text-sm">
                            在居住決策中，最大筆的隱生成本通常是「機會成本」。如果您選擇買房，這代表您的「頭期款」將無法投入股市或其他資產。本計算機特別納入了這項因素，幫助您評估：如果將買房的錢拿去投資大盤，30
                            年後的資產是否會更高？
                        </p>
                    </div>
                    <div class="space-y-4">
                        <h3
                            class="text-xl font-bold text-slate-900 flex items-center gap-2"
                        >
                            <span class="w-1.5 h-6 bg-blue-600 rounded-full"
                            ></span>
                            「黃金交叉點」的意義
                        </h3>
                        <p class="text-slate-600 leading-relaxed text-sm">
                            買房通常伴隨著沉重的交易成本（稅金、仲介費、裝潢）。這意味著在持有的前幾年，租房通常更划算。所謂的黃金交叉點，是指「持有房屋的增值加上本金償還」開始超越「租房累積投資」的時間點。
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-900 rounded-[2.5rem] p-8 md:p-12 text-white">
                <h3
                    class="text-2xl font-extrabold text-amber-400 mb-8 text-center"
                >
                    居住決策 FAQ
                </h3>
                <div class="space-y-6">
                    <div
                        class="bg-white/5 rounded-2xl p-6 border border-white/10"
                    >
                        <h4 class="text-lg font-bold mb-2 text-white">
                            為什麼計算結果建議我租房？
                        </h4>
                        <p class="text-slate-400 text-sm">
                            當「預期房價漲幅」低於「投資回報率」時，租房並將差額投入市場往往能累積更多財富。此外，若租金收益比（Rent-to-Price
                            Ratio）過低，也會讓買房顯得不具吸引力。
                        </p>
                    </div>
                    <div
                        class="bg-white/5 rounded-2xl p-6 border border-white/10"
                    >
                        <h4 class="text-lg font-bold mb-2 text-white">
                            這個工具考慮了持有費用嗎？
                        </h4>
                        <p class="text-slate-400 text-sm">
                            是的。除了房貸本息，我們也讓您設定「持有成本比例」，這包含地價稅、房屋稅、社區管理費以及長期的修繕費用，確保比較結果更貼近現實。
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>
</Layout>

<script>
    import Chart from "chart.js/auto";

    // State
    const state = {
        homePrice: 20000000,
        downPaymentPct: 20,
        mortgageRate: 2.2,
        mortgageYears: 30,
        appreciation: 2,
        holdingCostPct: 1.5,
        managementFee: 3000,
        rent: 35000,
        rentInflation: 2,
        investReturn: 7,
    };

    let chart: any = null;

    // Elements
    const inputs = {
        homePrice: document.getElementById("home-price") as HTMLInputElement,
        downPaymentPct: document.getElementById(
            "down-payment",
        ) as HTMLInputElement,
        mortgageRate: document.getElementById(
            "mortgage-rate",
        ) as HTMLInputElement,
        mortgageYears: document.getElementById(
            "mortgage-years",
        ) as HTMLInputElement,
        appreciation: document.getElementById(
            "appreciation",
        ) as HTMLInputElement,
        holdingCostPct: document.getElementById(
            "holding-cost",
        ) as HTMLInputElement,
        managementFee: document.getElementById("mgmt-fee") as HTMLInputElement,
        rent: document.getElementById("rent") as HTMLInputElement,
        rentInflation: document.getElementById(
            "rent-inflation",
        ) as HTMLInputElement,
        investReturn: document.getElementById(
            "invest-return",
        ) as HTMLInputElement,
    };

    const labels = {
        homePrice: document.getElementById("val-home-price"),
        downPaymentPct: document.getElementById("val-down-payment"),
        mortgageRate: document.getElementById("val-mortgage-rate"),
        mortgageYears: document.getElementById("val-mortgage-years"),
        appreciation: document.getElementById("val-appreciation"),
        holdingCostPct: document.getElementById("val-holding-cost"),
        managementFee: document.getElementById("val-mgmt-fee"),
        rent: document.getElementById("val-rent"),
        rentInflation: document.getElementById("val-rent-inflation"),
        investReturn: document.getElementById("val-invest-return"),
        resBuyNw: document.getElementById("res-buy-nw"),
        resRentNw: document.getElementById("res-rent-nw"),
        breakevenText: document.getElementById("breakeven-text"),
        verdictDesc: document.getElementById("verdict-desc"),
    };

    const moneyFmt = new Intl.NumberFormat("zh-TW", {
        style: "currency",
        currency: "TWD",
        maximumFractionDigits: 0,
    });

    function init() {
        Object.keys(inputs).forEach((key) => {
            const el = inputs[key as keyof typeof inputs];
            if (el) {
                el.addEventListener("input", (e) => {
                    const target = e.target as HTMLInputElement;
                    (state as any)[key] = parseFloat(target.value);
                    update();
                });
            }
        });
        update();
    }

    function calculateMortgage(principal: number, rate: number, years: number) {
        const monthlyRate = rate / 100 / 12;
        const numberOfPayments = years * 12;
        return (
            (principal *
                monthlyRate *
                Math.pow(1 + monthlyRate, numberOfPayments)) /
            (Math.pow(1 + monthlyRate, numberOfPayments) - 1)
        );
    }

    function calculate() {
        // Initial Buy Costs
        const downPayment = state.homePrice * (state.downPaymentPct / 100);
        const loanAmount = state.homePrice - downPayment;
        const monthlyMortgage = calculateMortgage(
            loanAmount,
            state.mortgageRate,
            state.mortgageYears,
        );

        // Initial Investment = Down Payment + Buying Costs (Assume 2% for stamps/fees)
        const buyingCosts = state.homePrice * 0.02;
        const initialCashOutlay = downPayment + buyingCosts;

        // Buying Variables
        let houseValue = state.homePrice;
        let loanBalance = loanAmount;
        let buyInvestments = 0;

        // Rent Scenario Initial
        let rentInvestments = initialCashOutlay;
        let currentMonthlyRent = state.rent;

        const maxYears = 30;
        const buyData = [];
        const rentData = [];
        const chartLabels = [];
        let breakevenYear = -1;

        for (let year = 0; year <= maxYears; year++) {
            chartLabels.push(`第 ${year} 年`);

            if (year === 0) {
                const startBuyNW =
                    state.homePrice - loanAmount - state.homePrice * 0.04;
                buyData.push(startBuyNW);
                rentData.push(rentInvestments);
                continue;
            }

            // Monthly Calc Loop for the Year
            for (let m = 0; m < 12; m++) {
                const monthlyHolding =
                    (houseValue * (state.holdingCostPct / 100)) / 12 +
                    state.managementFee;
                const monthlyBuyOutflow = monthlyMortgage + monthlyHolding;
                const monthlyRentOutflow = currentMonthlyRent;

                const diff = monthlyRentOutflow - monthlyBuyOutflow;
                const monthlyReturn = state.investReturn / 100 / 12;

                if (diff > 0) {
                    buyInvestments =
                        (buyInvestments + diff) * (1 + monthlyReturn);
                    rentInvestments = rentInvestments * (1 + monthlyReturn);
                } else {
                    rentInvestments =
                        (rentInvestments + -diff) * (1 + monthlyReturn);
                    buyInvestments = buyInvestments * (1 + monthlyReturn);
                }

                const interestPayment =
                    loanBalance * (state.mortgageRate / 100 / 12);
                const principalPayment = monthlyMortgage - interestPayment;
                if (loanBalance > 0) {
                    loanBalance -= principalPayment;
                    if (loanBalance < 0) loanBalance = 0;
                }
            }

            houseValue = houseValue * (1 + state.appreciation / 100);
            currentMonthlyRent =
                currentMonthlyRent * (1 + state.rentInflation / 100);

            const sellingCost = houseValue * 0.04;
            const buyNW =
                houseValue - loanBalance + buyInvestments - sellingCost;
            const rentNW = rentInvestments;

            buyData.push(buyNW);
            rentData.push(rentNW);

            if (buyNW > rentNW && breakevenYear === -1) {
                breakevenYear = year;
            }
        }

        return { buyData, rentData, labels: chartLabels, breakevenYear };
    }

    function update() {
        // UI Labels
        if (labels.homePrice)
            labels.homePrice.textContent =
                "$" + (state.homePrice / 10000).toFixed(0) + "萬";
        if (labels.downPaymentPct)
            labels.downPaymentPct.textContent = state.downPaymentPct + "%";
        if (labels.mortgageRate)
            labels.mortgageRate.textContent = state.mortgageRate + "%";
        if (labels.mortgageYears)
            labels.mortgageYears.textContent = state.mortgageYears + "年";
        if (labels.appreciation)
            labels.appreciation.textContent = state.appreciation + "%";
        if (labels.holdingCostPct)
            labels.holdingCostPct.textContent = state.holdingCostPct + "%";
        if (labels.managementFee)
            labels.managementFee.textContent = moneyFmt.format(
                state.managementFee,
            );
        if (labels.rent) labels.rent.textContent = moneyFmt.format(state.rent);
        if (labels.rentInflation)
            labels.rentInflation.textContent = state.rentInflation + "%";
        if (labels.investReturn)
            labels.investReturn.textContent = state.investReturn + "%";

        // Calculation
        const res = calculate();

        // Final Results
        const finalBuy = res.buyData[res.buyData.length - 1];
        const finalRent = res.rentData[res.rentData.length - 1];

        if (labels.resBuyNw)
            labels.resBuyNw.textContent = moneyFmt.format(finalBuy);
        if (labels.resRentNw)
            labels.resRentNw.textContent = moneyFmt.format(finalRent);

        if (res.breakevenYear !== -1) {
            if (labels.breakevenText) {
                labels.breakevenText.textContent = `第 ${res.breakevenYear} 年`;
                labels.breakevenText.className =
                    "text-3xl font-bold text-amber-400 mb-2";
            }
            if (labels.verdictDesc)
                labels.verdictDesc.textContent = `如果您打算持有超過 ${res.breakevenYear} 年，買房將會比租房累積更多財富 (已扣除交易成本與機會成本)。`;
        } else {
            if (finalRent > finalBuy) {
                if (labels.breakevenText) {
                    labels.breakevenText.textContent = "租房勝出的可能性高";
                    labels.breakevenText.className =
                        "text-3xl font-bold text-emerald-400 mb-2";
                }
                if (labels.verdictDesc)
                    labels.verdictDesc.textContent = `在目前的參數下 (尤其是 ${state.investReturn}% 的投資回報率)，持續租房並將資金投資於市場，30年後的淨資產可能高於買房。`;
            } else {
                if (labels.breakevenText) {
                    labels.breakevenText.textContent = "買房勝出";
                    labels.breakevenText.className =
                        "text-3xl font-bold text-blue-400 mb-2";
                }
            }
        }

        renderChart(res);
    }

    function renderChart(data: any) {
        const ctx = document.getElementById(
            "comparisonChart",
        ) as HTMLCanvasElement;
        if (!ctx) return;

        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: "買房淨資產 (Buy)",
                        data: data.buyData,
                        borderColor: "#2563EB",
                        backgroundColor: "rgba(37, 99, 235, 0.1)",
                        borderWidth: 3,
                        pointRadius: 0,
                        tension: 0.4,
                    },
                    {
                        label: "租房淨資產 (Rent)",
                        data: data.rentData,
                        borderColor: "#10B981",
                        backgroundColor: "rgba(16, 185, 129, 0.1)",
                        borderWidth: 3,
                        pointRadius: 0,
                        tension: 0.4,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    mode: "index",
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: "30年財富累積曲線 (考慮機會成本)",
                    },
                    tooltip: {
                        backgroundColor: "rgba(255, 255, 255, 0.9)",
                        titleColor: "#1e293b",
                        bodyColor: "#475569",
                        borderColor: "#e2e8f0",
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || "";
                                if (label) {
                                    label += ": ";
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat("zh-TW", {
                                        style: "currency",
                                        currency: "TWD",
                                        maximumFractionDigits: 0,
                                    }).format(context.parsed.y);
                                }
                                return label;
                            },
                        },
                    },
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: 10 },
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: "#f1f5f9" },
                        ticks: {
                            callback: function (value, index, values) {
                                // @ts-ignore
                                return "$" + value / 10000 + "萬";
                            },
                        },
                    },
                },
            },
        });
    }

    init();
</script>
